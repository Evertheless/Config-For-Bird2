log syslog all;
log "/var/log/bird.log" { debug, trace, info, remote, warning, error, auth, fatal, bug };

router id 194.50.19.95;

define my_v6 = [2404:f4c0:fd00::/44{44,48}, 2a06:1287:4200::/40{40,48}, 2a0d:2587:c220::/44{44,48}, 2a0e:b107:19c4::/47{47,48}];

define tier1_as = [7018, 3320, 3257, 6830, 3356, 2914, 5511, 3491, 1239, 6453, 6762, 1299, 12956, 701, 6461, 174, 6939, 4134, 4809, 7473, 7902, 9002, 1273, 2828, 4637];

define BOGON_ASNS = [
    0,                      # RFC 7607
    23456,                  # RFC 4893 AS_TRANS
    64496..64511,           # RFC 5398 and documentation/example ASNs
    64512..65534,           # RFC 6996 Private ASNs
    65535,                  # RFC 7300 Last 16 bit ASN
    65536..65551,           # RFC 5398 and documentation/example ASNs
    65552..131071,          # RFC IANA reserved ASNs
    4200000000..4294967294, # RFC 6996 Private ASNs
    4294967295              # RFC 7300 Last 32 bit ASN
];

define BOGON_PREFIXES_V4 = [
    0.0.0.0/8+,             # RFC 1122 'this' network
    10.0.0.0/8+,            # RFC 1918 private space
    100.64.0.0/10+,         # RFC 6598 Carrier grade nat space
    127.0.0.0/8+,           # RFC 1122 localhost
    169.254.0.0/16+,        # RFC 3927 link local
    172.16.0.0/12+,         # RFC 1918 private space 
    192.0.2.0/24+,          # RFC 5737 TEST-NET-1
    192.88.99.0/24{25,32},        # RFC 7526 deprecated 6to4 relay anycast.
    192.168.0.0/16+,        # RFC 1918 private space
    198.18.0.0/15+,         # RFC 2544 benchmarking
    198.51.100.0/24+,       # RFC 5737 TEST-NET-2
    203.0.113.0/24+,        # RFC 5737 TEST-NET-3
    224.0.0.0/4+,           # multicast
    240.0.0.0/4+            # reserved
];

define BOGON_PREFIXES_V6 = [
    ::/8+,                  # RFC 4291 IPv4-compatible, loopback, et al
    0064:ff9b::/96+,        # RFC 6052 IPv4/IPv6 Translation
    0064:ff9b:1::/48+,      # RFC 8215 Local-Use IPv4/IPv6 Translation
    0100::/64+,             # RFC 6666 Discard-Only
    2001::/32{33,128},      # RFC 4380 Teredo, no more specific
    2001:2::/48+,           # RFC 5180 BMWG
    2001:10::/28+,          # RFC 4843 ORCHID
    2001:db8::/32+,         # RFC 3849 documentation
    2002::/16{17,128},      
    3ffe::/16+, 5f00::/8+,  # RFC 3701
    fc00::/7+,              # RFC 4193 unique local unicast
    fe80::/10+,             # RFC 4291 link local unicast
    fec0::/10+,             # RFC 3879 old site local unicast
    ff00::/8+               # RFC 4291 multicast
];

function check_bogon_as() {
	if bgp_path ~ BOGON_ASNS then return true;
    case net.type {
        NET_IP4: return net.len > 24 || net ~ BOGON_PREFIXES_V4;
        NET_IP6: return net.len > 48 || net ~ BOGON_PREFIXES_V6;
        else: print "unexpected net.type" , net.type, " ", net; return false;
    }
}

function check_bogon_net() {
    case net.type {
        NET_IP4: return net ~ BOGON_PREFIXES_V4;
        NET_IP6: return net ~ BOGON_PREFIXES_V6;
        else: print "is_bogon_prefix: unexpected net.type ", net.type, " ", net;
	return false;
    }
}

function tier1_check() {
    if bgp_path.first ~ [131171, 147028] then return false;
    return true;
}

filter export_peer {
    if net ~ my_v6 then accept;
    if tier1_check() then reject;
    if check_bogon_as() then reject;
    if check_bogon_net() then reject;
    reject;
}

filter import_peer {
    if check_bogon_as() then reject;
    if check_bogon_net() then reject;
    accept;
}

template bgp i_bgp {
    local as 131171;
    graceful restart;
    direct;
    ipv6 {
	import all;
	export all;
	next hop self;
    };
}

template bgp e_bgp {
    local as 131171;
    graceful restart;
    multihop 2;
}

protocol device {
}

protocol direct {
	ipv4;			# Connect to default IPv4 table
	ipv6;			# ... and to default IPv6 table
}

protocol kernel {
	ipv4 {			# Connect protocol to IPv4 table by channel
	      export all;	# Export to protocol. default is export none
	};
}

protocol kernel {
    ipv6 {
	export filter {
	    krt_prefsrc = 2404:f4c0:fd04::1;
	    accept;
	};
    };
}

protocol static {
	ipv4;		# Again, IPv4 channel with default options
}

protocol bgp AS202409IX1 from e_bgp {
	source address 2001:7f8:f2:e1:0:a513:1171:1;
	neighbor 2001:7f8:f2:e1::babe:1 as 202409;
    ipv6 {
	import filter import_peer;
	export filter export_peer;
	export limit 100;
    };
}

protocol bgp AS202409IX2 from e_bgp {
	source address 2001:7f8:f2:e1:0:a513:1171:1;
	neighbor 2001:7f8:f2:e1::dead:1 as 202409;
    ipv6 {
	import filter import_peer;
	export filter export_peer;
	export limit 100;
    };
}

protocol bgp AS202409IX3 from e_bgp {
         source address 2001:7f8:f2:e1:0:a513:1171:1;
        neighbor 2001:7f8:f2:e1::be5a as 202409;
    ipv6 {
        import filter import_peer;
        export filter export_peer;
	export limit 100;
    };
}

include "/root/bird/*";

protocol bgp AS147028 from e_bgp {
	source address 2001:7f8:33::a113:1171:1;
	neighbor 2001:7f8:33::a114:7028:1 as 147028;
    ipv6 {
	export filter export_peer;
	import filter import_peer;
    };
}

protocol bgp AS131171LU from i_bgp {
	source address 2404:f4c0:fd00:6::1;
	neighbor 2404:f4c0:fd00:6::2 as 131171;
}

protocol static
{
    ipv6;
    route  2404:f4c0:fd04::/48 reject;
    route  2001:7f8:f2::/48 recursive 2001:7f8:f2:e1:0:a513:1171:1; 
    route  2001:7f8:33::/48 recursive 2001:7f8:33::a113:1171:1;
}

protocol direct
{
    interface "dummy*" , "AS*";
}

